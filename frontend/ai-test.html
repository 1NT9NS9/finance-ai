<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Test - Gemini Integration</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #111;
            color: #fff;
        }

        .container {
            background: #222;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .status.success {
            background: #2d5a2d;
        }

        .status.error {
            background: #5a2d2d;
        }

        .status.warning {
            background: #5a5a2d;
        }

        .status.info {
            background: #2d2d5a;
        }

        input,
        textarea,
        button {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #555;
            border-radius: 5px;
            background: #333;
            color: #fff;
            font-size: 14px;
        }

        button {
            background: #28a745;
            cursor: pointer;
            width: auto;
            padding: 10px 20px;
        }

        button:hover {
            background: #34ce57;
        }

        button:disabled {
            background: #555;
            cursor: not-allowed;
        }

        #response {
            background: #333;
            padding: 15px;
            border-radius: 5px;
            white-space: pre-wrap;
            min-height: 100px;
            border: 1px solid #555;
        }

        .test-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .test-buttons button {
            flex: 1;
            min-width: 150px;
        }

        pre {
            background: #333;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>

<body>
    <h1>ü§ñ AI Integration Test</h1>
    <p>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Gemini AI –¥–ª—è –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω–æ–≥–æ —Å–∞–π—Ç–∞</p>

    <!-- API Key Configuration -->
    <div class="container">
        <h2>üîë Backend Access Configuration</h2>
        <p>Ensure your real Gemini API Key is in the backend <code>.env</code> file.</p>
        <input type="password" id="apiKeyInput" placeholder="Backend Access Key (e.g., fdml_demo_key_12345)">
        <button onclick="setApiKey()">Set Access Key</button>
        <div id="apiStatus" class="status info">
            Status: Unknown
        </div>
    </div>

    <!-- System Status -->
    <div class="container">
        <h2>üìä –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã</h2>
        <button onclick="checkStatus()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>
        <div id="systemStatus" class="status info">
            –ù–∞–∂–º–∏—Ç–µ "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å" –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
        </div>
    </div>

    <!-- Quick Tests -->
    <div class="container">
        <h2>‚ö° –ë—ã—Å—Ç—Ä—ã–µ —Ç–µ—Å—Ç—ã</h2>
        <div class="test-buttons">
            <button onclick="testBasic()">–ë–∞–∑–æ–≤—ã–π —Ç–µ—Å—Ç</button>
            <button onclick="testInvestment()">–¢–µ—Å—Ç –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π</button>
            <button onclick="testMarket()">–¢–µ—Å—Ç —Ä—ã–Ω–∫–∞</button>
            <button onclick="testFallback()">–¢–µ—Å—Ç fallback</button>
        </div>
    </div>

    <!-- Custom Message Test -->
    <div class="container">
        <h2>üí¨ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π</h2>
        <textarea id="messageInput" rows="3"
            placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">–†–∞—Å—Å–∫–∞–∂–∏ –ø—Ä–æ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ –≤ —Ä–æ—Å—Å–∏–π—Å–∫–∏–µ –∞–∫—Ü–∏–∏</textarea>
        <button onclick="sendTestMessage()" id="sendButton">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</button>
        <h3>–û—Ç–≤–µ—Ç AI:</h3>
        <div id="response">–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –æ—Ç–≤–µ—Ç...</div>
    </div>

    <!-- Debug Info -->
    <div class="container">
        <h2>üîç –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
        <button onclick="showDebugInfo()">–ü–æ–∫–∞–∑–∞—Ç—å debug</button>
        <pre id="debugInfo"></pre>
    </div>

    <!-- Include our scripts -->
    <script src="environment.js?v=2.5"></script>
    <script src="config.js?v=2.5"></script>
    <script src="gemini-api.js?v=2.5"></script>

    <script>
        let isLoading = false;

        // Set API key
        function setApiKey() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            if (!apiKey) {
                showStatus('apiStatus', '–í–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á', 'error');
                return;
            }

            // üåç Set API key in Environment (will automatically update all modules)
            window.Environment.set('GEMINI_API_KEY', apiKey);

            showStatus('apiStatus', 'API –∫–ª—é—á —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ! –í—Å–µ –º–æ–¥—É–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã.', 'success');
            checkStatus();
        }

        // Check system status
        async function checkStatus() {
            showStatus('systemStatus', '–ü—Ä–æ–≤–µ—Ä–∫–∞...', 'info');

            try {
                // Check configuration
                const isConfigured = window.GeminiAI.isConfigured();
                let statusText = `üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: ${isConfigured ? '‚úÖ' : '‚ùå'}\n`;

                // Check network connectivity
                statusText += `üåê –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ: –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è...\n`;

                if (isConfigured) {
                    // Test API connectivity
                    const healthCheck = await window.GeminiAI.healthCheck();
                    statusText += `ü§ñ AI –°–µ—Ä–≤–∏—Å: ${healthCheck.status === 'healthy' ? '‚úÖ' : '‚ùå'}\n`;
                    statusText += `üìù –¢–µ—Å—Ç –æ—Ç–≤–µ—Ç: ${healthCheck.response || healthCheck.error}\n`;

                    showStatus('systemStatus', statusText, healthCheck.status === 'healthy' ? 'success' : 'error');
                } else {
                    statusText += `ü§ñ AI –°–µ—Ä–≤–∏—Å: ‚ùå (API –∫–ª—é—á –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω)\n`;
                    showStatus('systemStatus', statusText, 'warning');
                }

            } catch (error) {
                showStatus('systemStatus', `‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }

        // Test functions
        async function testBasic() {
            await sendTestMessage('–ü—Ä–∏–≤–µ—Ç, —ç—Ç–æ —Ç–µ—Å—Ç');
        }

        async function testInvestment() {
            await sendTestMessage('–ö–∞–∫–∏–µ —Ä–æ—Å—Å–∏–π—Å–∫–∏–µ –∞–∫—Ü–∏–∏ –ø–æ—Å–æ–≤–µ—Ç—É–µ—à—å –¥–ª—è –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã—Ö –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π?');
        }

        async function testMarket() {
            await sendTestMessage('–ö–∞–∫ —Å–µ–π—á–∞—Å –¥–µ–ª–∞ —É –°–±–µ—Ä–±–∞–Ω–∫–∞ –Ω–∞ —Ñ–æ–Ω–¥–æ–≤–æ–º —Ä—ã–Ω–∫–µ?');
        }

        async function testFallback() {
            // Temporarily break the API to test fallback
            const originalKey = window.GeminiAI.apiKey;
            window.GeminiAI.setApiKey('invalid_key');

            await sendTestMessage('–¢–µ—Å—Ç fallback –æ—Ç–≤–µ—Ç–æ–≤');

            // Restore original key
            window.GeminiAI.setApiKey(originalKey);
        }

        // Send test message
        async function sendTestMessage(customMessage = null) {
            if (isLoading) return;

            const message = customMessage || document.getElementById('messageInput').value.trim();
            if (!message) {
                showResponse('–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏');
                return;
            }

            isLoading = true;
            const sendButton = document.getElementById('sendButton');
            const originalText = sendButton.textContent;
            sendButton.textContent = '–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è...';
            sendButton.disabled = true;

            showResponse('ü§ñ –ø–µ—á–∞—Ç–∞–µ—Ç...');

            try {
                const startTime = Date.now();
                const response = await window.GeminiAI.getResponse(message);
                const endTime = Date.now();
                const duration = endTime - startTime;

                showResponse(`${response}\n\n‚è±Ô∏è –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: ${duration}ms`);

            } catch (error) {
                showResponse(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`);
            } finally {
                isLoading = false;
                sendButton.textContent = originalText;
                sendButton.disabled = false;
            }
        }

        // Show debug information
        function showDebugInfo() {
            const debugInfo = {
                timestamp: new Date().toISOString(),
                config: {
                    apiConfigured: window.GeminiAI.isConfigured(),
                    baseURL: window.GeminiAI.baseURL,
                    timeout: window.GeminiAI.timeout,
                    maxRetries: window.GeminiAI.maxRetries
                },
                browser: {
                    userAgent: navigator.userAgent,
                    language: navigator.language,
                    onLine: navigator.onLine
                },
                localStorage: {
                    keys: Object.keys(localStorage),
                    size: JSON.stringify(localStorage).length
                }
            };

            document.getElementById('debugInfo').textContent = JSON.stringify(debugInfo, null, 2);
        }

        // Utility functions
        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
        }

        function showResponse(text) {
            document.getElementById('response').textContent = text;
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function () {
            console.log('AI Test Page loaded');
            // Force re-initialization to ensure all settings (including Model) are applied
            if (window.Environment) {
                window.Environment.init();
            }

            checkStatus();

            // Auto-fill API key if available in environment
            const envKey = window.Environment?.GEMINI_API_KEY;
            if (envKey && envKey !== 'YOUR_GEMINI_API_KEY_HERE') {
                document.getElementById('apiKeyInput').value = envKey;
                showStatus('apiStatus', 'API –∫–ª—é—á –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏', 'success');
            }
        });

        // Allow Enter key to send messages
        document.getElementById('messageInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendTestMessage();
            }
        });
    </script>
</body>

</html>