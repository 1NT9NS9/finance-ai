<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Environment Setup - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .setup-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #111;
            color: #fff;
            font-family: Arial, sans-serif;
        }

        .setup-card {
            background: #222;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            border: 1px solid #333;
        }

        .setup-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .setup-header h1 {
            color: #28a745;
            margin: 0;
            font-size: 2.5rem;
        }

        .setup-header p {
            color: #ccc;
            margin: 10px 0;
            font-size: 1.1rem;
        }

        .form-group {
            margin: 20px 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #fff;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #555;
            border-radius: 8px;
            background: #333;
            color: #fff;
            font-size: 14px;
            box-sizing: border-box;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: #28a745;
            outline: none;
        }

        .btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #34ce57;
        }

        .btn.secondary {
            background: #6c757d;
        }

        .btn.secondary:hover {
            background: #868e96;
        }

        .btn.danger {
            background: #dc3545;
        }

        .btn.danger:hover {
            background: #e4606d;
        }

        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: bold;
        }

        .status.success {
            background: #2d5a2d;
            color: #90ee90;
            border: 1px solid #28a745;
        }

        .status.error {
            background: #5a2d2d;
            color: #ffb3b3;
            border: 1px solid #dc3545;
        }

        .status.warning {
            background: #5a5a2d;
            color: #ffff99;
            border: 1px solid #ffc107;
        }

        .status.info {
            background: #2d2d5a;
            color: #99ccff;
            border: 1px solid #17a2b8;
        }

        .config-preview {
            background: #333;
            border: 1px solid #555;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }

        .quick-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin: 20px 0;
        }

        .feature-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            background: #333;
            border-radius: 8px;
            margin: 5px 0;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
            background: #555;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: #28a745;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: left 0.3s;
        }

        .toggle-switch.active::after {
            left: 28px;
        }

        .instruction {
            background: #1a1a2e;
            border-left: 4px solid #28a745;
            padding: 15px;
            margin: 15px 0;
        }

        .instruction h3 {
            margin: 0 0 10px 0;
            color: #28a745;
        }

        .code-block {
            background: #2d2d2d;
            border: 1px solid #555;
            border-radius: 5px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin: 10px 0;
            overflow-x: auto;
        }
    </style>
</head>

<body>
    <div class="setup-container">
        <!-- Header -->
        <div class="setup-header">
            <h1>üîß Environment Setup</h1>
            <p>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è AI-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏</p>
            <p><small>–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ API –∫–ª—é—á –æ–¥–∏–Ω —Ä–∞–∑ - –æ–Ω –±—É–¥–µ—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω –≤–µ–∑–¥–µ</small></p>
        </div>

        <!-- API Key Setup -->
        <div class="setup-card">
            <h2>üîë API Configuration</h2>
            <div class="instruction">
                <h3>Server-Side Configuration</h3>
                <p>‚ö†Ô∏è <strong>Important:</strong> Your actual Gemini API Key must be configured in the <code>.env</code>
                    file of your backend server.</p>
                <p>The field below is for the <strong>Backend Access Key</strong> (default:
                    <code>fdml_demo_key_12345</code>), which allows this frontend to talk to your server.</p>
            </div>

            <div class="form-group">
                <label for="apiKey">üîê Backend Access Key:</label>
                <input type="password" id="apiKey" placeholder="fdml_demo_key_12345">
            </div>

            <div class="quick-actions">
                <button class="btn" onclick="setApiKey()">üíæ Save Access Key</button>
                <button class="btn secondary" onclick="testApiKey()">üß™ Test Connection</button>
                <button class="btn secondary" onclick="toggleApiKeyVisibility()">üëÅÔ∏è Show/Hide</button>
            </div>

            <div id="apiStatus" class="status info">
                Backend connection status: Unknown
            </div>
        </div>

        <!-- Environment Settings -->
        <div class="setup-card">
            <h2>‚öôÔ∏è Environment Settings</h2>

            <div class="form-group">
                <label for="environment">üåç Environment Mode:</label>
                <select id="environment" onchange="updateEnvironment()">
                    <option value="development">Development (—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞)</option>
                    <option value="production">Production (–ø—Ä–æ–¥–∞–∫—à–Ω)</option>
                </select>
            </div>

            <div class="form-group">
                <label for="messagesPerDay">üìä Messages Per Day (—Å–æ–æ–±—â–µ–Ω–∏–π –≤ –¥–µ–Ω—å):</label>
                <input type="number" id="messagesPerDay" value="10" min="1" max="1000" onchange="updateEnvironment()">
            </div>

            <div class="form-group">
                <label for="apiTimeout">‚è±Ô∏è API Timeout (—Å–µ–∫—É–Ω–¥—ã):</label>
                <input type="number" id="apiTimeout" value="30" min="5" max="120" onchange="updateEnvironment()">
            </div>
        </div>

        <!-- Feature Flags -->
        <div class="setup-card">
            <h2>üéõÔ∏è Feature Flags</h2>

            <div class="feature-toggle">
                <span>ü§ñ AI Responses (–æ—Ç–≤–µ—Ç—ã AI)</span>
                <div class="toggle-switch active" id="toggle-ai" onclick="toggleFeature('ai')"></div>
            </div>

            <div class="feature-toggle">
                <span>üë• User Registration (—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è)</span>
                <div class="toggle-switch active" id="toggle-registration" onclick="toggleFeature('registration')">
                </div>
            </div>

            <div class="feature-toggle">
                <span>üí∞ Paywall (–ø–ª–∞—Ç–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞)</span>
                <div class="toggle-switch active" id="toggle-paywall" onclick="toggleFeature('paywall')"></div>
            </div>

            <div class="feature-toggle">
                <span>üîç Debug Mode (–æ—Ç–ª–∞–¥–∫–∞)</span>
                <div class="toggle-switch active" id="toggle-debug" onclick="toggleFeature('debug')"></div>
            </div>
        </div>

        <!-- System Status -->
        <div class="setup-card">
            <h2>üìä System Status</h2>
            <div class="quick-actions">
                <button class="btn" onclick="checkSystemStatus()">üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>
                <button class="btn secondary" onclick="showCurrentConfig()">üìã –ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é</button>
                <button class="btn secondary" onclick="exportConfig()">üíæ –≠–∫—Å–ø–æ—Ä—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫</button>
                <button class="btn danger" onclick="resetToDefaults()">üîÑ –°–±—Ä–æ—Å –∫ —É–º–æ–ª—á–∞–Ω–∏—è–º</button>
            </div>

            <div id="systemStatus" class="status info">
                –ù–∞–∂–º–∏—Ç–µ "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å" –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
            </div>

            <div id="configPreview" class="config-preview" style="display: none;"></div>
        </div>

        <!-- Quick Start -->
        <div class="setup-card">
            <h2>üöÄ Quick Start</h2>
            <div class="instruction">
                <h3>–ë—ã—Å—Ç—Ä—ã–π –∑–∞–ø—É—Å–∫:</h3>
                <div class="code-block">1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ API –∫–ª—é—á –≤—ã—à–µ ‚òùÔ∏è
                    2. –ù–∞–∂–º–∏—Ç–µ "–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å" –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
                    3. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ <a href="index.html" style="color: #28a745;">–≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É</a>
                    4. –û—Ç–∫—Ä–æ–π—Ç–µ <a href="chat.html" style="color: #28a745;">—á–∞—Ç</a> –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ AI</div>
            </div>

            <div class="quick-actions">
                <button class="btn" onclick="window.open('index.html', '_blank')">üè† –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞</button>
                <button class="btn" onclick="window.open('chat.html', '_blank')">üí¨ –û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç</button>
                <button class="btn secondary" onclick="window.open('ai-test.html', '_blank')">üß™ AI Test Page</button>
            </div>
        </div>
    </div>

    <!-- Include Scripts -->
    <script src="environment.js?v=2.5"></script>
    <script src="config.js?v=2.5"></script>
    <script src="gemini-api.js?v=2.5"></script>

    <script>
        let currentConfig = {};

        // Initialize page
        document.addEventListener('DOMContentLoaded', function () {
            loadCurrentSettings();
            checkSystemStatus();
        });

        // Load current settings from Environment
        function loadCurrentSettings() {
            if (!window.Environment) return;

            const env = window.Environment;

            // Load API key (masked)
            if (env.GEMINI_API_KEY && env.GEMINI_API_KEY !== 'YOUR_GEMINI_API_KEY_HERE') {
                document.getElementById('apiKey').value = env.GEMINI_API_KEY;
            }

            // Load environment settings
            document.getElementById('environment').value = env.APP_ENVIRONMENT || 'development';
            document.getElementById('messagesPerDay').value = env.MESSAGES_PER_DAY || 10;
            document.getElementById('apiTimeout').value = (env.API_TIMEOUT || 30000) / 1000;

            // Load feature flags
            updateToggle('toggle-ai', env.ENABLE_AI_RESPONSES);
            updateToggle('toggle-registration', env.ENABLE_USER_REGISTRATION);
            updateToggle('toggle-paywall', env.ENABLE_PAYWALL);
            updateToggle('toggle-debug', env.ENABLE_DEBUG_MODE);

            // Load Model
            const modelSelect = document.getElementById('aiModel');
            if (modelSelect) {
                modelSelect.value = env.GEMINI_MODEL || 'gemini-2.5-flash-lite';
            }
        }

        // Set API key
        function setApiKey() {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) {
                showStatus('apiStatus', '‚ùå –í–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á', 'error');
                return;
            }

            if (apiKey.length < 20) {
                showStatus('apiStatus', '‚ùå API –∫–ª—é—á —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π', 'error');
                return;
            }

            // Set in Environment (will update all modules)
            window.Environment.set('GEMINI_API_KEY', apiKey);

            showStatus('apiStatus', '‚úÖ API –∫–ª—é—á —Å–æ—Ö—Ä–∞–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ! –í—Å–µ –º–æ–¥—É–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã.', 'success');

            // Auto-test after setting
            setTimeout(testApiKey, 1000);
        }

        // Test API key
        async function testApiKey() {
            if (!window.GeminiAI || !window.GeminiAI.isConfigured()) {
                showStatus('apiStatus', '‚ùå API –∫–ª—é—á –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω', 'error');
                return;
            }

            showStatus('apiStatus', 'üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API...', 'info');

            try {
                const response = await window.GeminiAI.getResponse('–ü—Ä–∏–≤–µ—Ç, —ç—Ç–æ —Ç–µ—Å—Ç API');
                if (response && !response.includes('–û—à–∏–±–∫–∞')) {
                    showStatus('apiStatus', '‚úÖ API —Ä–∞–±–æ—Ç–∞–µ—Ç! –û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω: ' + response.substring(0, 50) + '...', 'success');
                } else {
                    showStatus('apiStatus', '‚ö†Ô∏è API –æ—Ç–≤–µ—á–∞–µ—Ç, –Ω–æ –≤–æ–∑–º–æ–∂–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã: ' + response, 'warning');
                }
            } catch (error) {
                showStatus('apiStatus', '‚ùå –û—à–∏–±–∫–∞ API: ' + error.message, 'error');
            }
        }

        // Toggle API key visibility
        function toggleApiKeyVisibility() {
            const input = document.getElementById('apiKey');
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        // Update environment settings
        function updateEnvironment() {
            const environment = document.getElementById('environment').value;
            const messagesPerDay = parseInt(document.getElementById('messagesPerDay').value);
            const apiTimeout = parseInt(document.getElementById('apiTimeout').value) * 1000;

            window.Environment.set('APP_ENVIRONMENT', environment);
            window.Environment.set('MESSAGES_PER_DAY', messagesPerDay);
            window.Environment.set('MESSAGES_PER_DAY', messagesPerDay);
            window.Environment.set('API_TIMEOUT', apiTimeout);

            const model = document.getElementById('aiModel').value;
            window.Environment.set('GEMINI_MODEL', model);

            console.log('üîß Environment updated:', { environment, messagesPerDay, apiTimeout, model });
        }

        // Toggle feature
        function toggleFeature(feature) {
            const toggleElement = document.getElementById(`toggle-${feature}`);
            const isActive = toggleElement.classList.contains('active');

            updateToggle(`toggle-${feature}`, !isActive);

            // Update Environment
            switch (feature) {
                case 'ai':
                    window.Environment.set('ENABLE_AI_RESPONSES', !isActive);
                    break;
                case 'registration':
                    window.Environment.set('ENABLE_USER_REGISTRATION', !isActive);
                    break;
                case 'paywall':
                    window.Environment.set('ENABLE_PAYWALL', !isActive);
                    break;
                case 'debug':
                    window.Environment.set('ENABLE_DEBUG_MODE', !isActive);
                    break;
            }
        }

        // Update toggle UI
        function updateToggle(elementId, isActive) {
            const element = document.getElementById(elementId);
            if (isActive) {
                element.classList.add('active');
            } else {
                element.classList.remove('active');
            }
        }

        // Check system status
        async function checkSystemStatus() {
            showStatus('systemStatus', 'üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º—ã...', 'info');

            try {
                let statusText = '';

                // Check Environment
                if (window.Environment) {
                    const validation = window.Environment.validate();
                    statusText += `üåç Environment: ${validation.valid ? '‚úÖ' : '‚ùå'}\n`;
                    if (!validation.valid) {
                        statusText += validation.issues.join('\n') + '\n';
                    }
                } else {
                    statusText += 'üåç Environment: ‚ùå –ù–µ –∑–∞–≥—Ä—É–∂–µ–Ω\n';
                }

                // Check GeminiAI
                if (window.GeminiAI) {
                    const isConfigured = window.GeminiAI.isConfigured();
                    statusText += `ü§ñ GeminiAI: ${isConfigured ? '‚úÖ' : '‚ùå'}\n`;

                    if (isConfigured) {
                        try {
                            const healthCheck = await window.GeminiAI.healthCheck();
                            statusText += `üîó API Connection: ${healthCheck.status === 'healthy' ? '‚úÖ' : '‚ùå'}\n`;
                        } catch (error) {
                            statusText += `üîó API Connection: ‚ùå ${error.message}\n`;
                        }
                    }
                } else {
                    statusText += 'ü§ñ GeminiAI: ‚ùå –ù–µ –∑–∞–≥—Ä—É–∂–µ–Ω\n';
                }

                // Check Config
                if (window.Config) {
                    statusText += '‚öôÔ∏è Config: ‚úÖ\n';
                } else {
                    statusText += '‚öôÔ∏è Config: ‚ùå –ù–µ –∑–∞–≥—Ä—É–∂–µ–Ω\n';
                }

                const hasErrors = statusText.includes('‚ùå');
                showStatus('systemStatus', statusText, hasErrors ? 'error' : 'success');

            } catch (error) {
                showStatus('systemStatus', '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏: ' + error.message, 'error');
            }
        }

        // Show current configuration
        function showCurrentConfig() {
            const preview = document.getElementById('configPreview');
            if (preview.style.display === 'none') {
                if (window.Environment) {
                    preview.textContent = window.Environment.export();
                    preview.style.display = 'block';
                } else {
                    preview.textContent = 'Environment –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω';
                    preview.style.display = 'block';
                }
            } else {
                preview.style.display = 'none';
            }
        }

        // Export configuration
        function exportConfig() {
            if (!window.Environment) {
                alert('Environment –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
                return;
            }

            const config = window.Environment.export();
            const blob = new Blob([config], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'environment-config.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        // Reset to defaults
        function resetToDefaults() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫ —É–º–æ–ª—á–∞–Ω–∏—é?')) {
                if (window.Environment) {
                    window.Environment.reset();
                    loadCurrentSettings();
                    showStatus('systemStatus', 'üîÑ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–±—Ä–æ—à–µ–Ω—ã –∫ —É–º–æ–ª—á–∞–Ω–∏—é', 'info');
                }
            }
        }

        // Utility function to show status
        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
        }
    </script>
</body>

</html>